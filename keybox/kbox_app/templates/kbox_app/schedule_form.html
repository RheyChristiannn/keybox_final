{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{% static 'kbox_app/css/style.css' %}">
  <!-- Select2 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <style>
    .form-container {
      max-width: 700px;
      margin: 40px auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .form-header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #388e3c;
    }
    .form-header h1 {
      margin: 0;
      color: #388e3c;
      font-size: 24px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    .form-group {
      margin-bottom: 25px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #0f0d0dff;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
      box-sizing: border-box;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #388e3c;
    }
    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    .checkbox-group label {
      margin: 0;
    }
    .error {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 5px;
      padding: 8px 12px;
      background: #ffebee;
      border-radius: 4px;
      border-left: 4px solid #d32f2f;
    }
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    .btn {
      padding: 14px 32px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #388e3c;
      color: white;
      flex: 1;
    }
    .btn-primary:hover {
      background: #2e7d32;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(56, 142, 60, 0.3);
    }
    .btn-secondary {
      background: #f5f5f5;
      color: #666;
      flex: 1;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #388e3c;
      text-decoration: none;
      font-weight: 600;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .help-text {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }
    .section-header {
      font-size: 18px;
      font-weight: 600;
      color: #388e3c;
      margin: 30px 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }

    /* Semester Toggle Buttons */
    .semester-toggle-container {
      margin-bottom: 25px;
    }
    
    .semester-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    
    .semester-radio {
      display: none;
    }
    
    .semester-label {
      display: block;
      padding: 16px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      background: white;
      user-select: none;
      position: relative;
    }
    
    .semester-label:hover {
      border-color: #388e3c;
      background: #f1f8f4;
      transform: translateY(-2px);
    }
    
    .semester-radio:checked + .semester-label {
      background: #388e3c;
      color: white;
      border-color: #388e3c;
      box-shadow: 0 4px 12px rgba(56, 142, 60, 0.3);
    }
    
    .semester-label .semester-icon {
      font-size: 24px;
      display: block;
      margin-bottom: 5px;
    }
    
    .semester-label .semester-name {
      font-size: 14px;
      font-weight: 600;
    }

    /* Days of Week Selection */
    .days-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .day-item {
      position: relative;
    }
    
    .day-checkbox {
      display: none;
    }
    
    .day-label {
      display: block;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      background: white;
      user-select: none;
      font-size: 14px;
    }
    
    .day-label:hover {
      border-color: #388e3c;
      background: #f1f8f4;
    }
    
    .day-checkbox:checked + .day-label {
      background: #388e3c;
      color: white;
      border-color: #388e3c;
    }
    
    .selected-days-preview {
      margin-top: 12px;
      padding: 10px 15px;
      background: #e8f5e9;
      border-radius: 6px;
      font-size: 14px;
      color: #2e7d32;
      display: none;
    }
    
    .selected-days-preview.active {
      display: block;
    }
    
    .selected-days-preview strong {
      font-weight: 700;
    }

    /* Semester Badge */
    .semester-badge {
      display: inline-block;
      padding: 6px 14px;
      background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
      color: white;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-left: 10px;
    }

    /* Select2 Custom Styling */
    .select2-container--default .select2-selection--single {
      height: 48px;
      border: 2px solid #0f0d0dff;
      border-radius: 8px;
      padding: 12px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 24px;
      padding-left: 0;
      color: #333;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 46px;
      right: 8px;
    }
    
    .select2-container--default.select2-container--focus .select2-selection--single {
      border-color: #388e3c;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #388e3c;
    }
    
    .select2-dropdown {
      border: 2px solid #388e3c;
      border-radius: 8px;
    }
    
    .select2-search--dropdown .select2-search__field {
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      padding: 8px;
    }
    
    .select2-search--dropdown .select2-search__field:focus {
      border-color: #388e3c;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'schedule_list' %}" class="back-link">‚Üê Back to Schedule List</a>
    
    <div class="form-container">
      <div class="form-header">
        <h1>{{ title }}</h1>
      </div>
      
      <form method="post" id="scheduleForm">
        {% csrf_token %}
        
        <!-- SEMESTER SELECTION -->
        <div class="section-header">
          üìÖ Academic Period
        </div>
        
        <div class="semester-toggle-container">
          <label>Select Semester *</label>
          <div class="semester-options">
            <div>
              <input type="radio" id="semester_1" name="semester" value="1st" class="semester-radio" 
                     {% if form.semester.value == '1st' %}checked{% endif %} required>
              <label for="semester_1" class="semester-label">
                <span class="semester-icon">üå±</span>
                <span class="semester-name">1st Semester</span>
              </label>
            </div>
            <div>
              <input type="radio" id="semester_2" name="semester" value="2nd" class="semester-radio" 
                     {% if form.semester.value == '2nd' %}checked{% endif %} required>
              <label for="semester_2" class="semester-label">
                <span class="semester-icon">üåø</span>
                <span class="semester-name">2nd Semester</span>
              </label>
            </div>
            <div>
              <input type="radio" id="semester_summer" name="semester" value="summer" class="semester-radio" 
                     {% if form.semester.value == 'summer' %}checked{% endif %} required>
              <label for="semester_summer" class="semester-label">
                <span class="semester-icon">‚òÄÔ∏è</span>
                <span class="semester-name">Summer</span>
              </label>
            </div>
            <div>
              <input type="radio" id="semester_summer2" name="semester" value="summer2" class="semester-radio" 
                     {% if form.semester.value == 'summer2' %}checked{% endif %} required>
              <label for="semester_summer2" class="semester-label">
                <span class="semester-icon">üåû</span>
                <span class="semester-name">Summer 2</span>
              </label>
            </div> 
          </div>
          <div class="help-text">Select the academic semester for this schedule</div>
          {% if form.semester.errors %}
            <div class="error">{{ form.semester.errors.0 }}</div>
          {% endif %}
          <div id="semesterError" class="error" style="display: none;">Please select a semester</div>
        </div>
        
        <div class="section-header">üè´ Room & Day Information</div>
        
        <div class="form-group">
          <label for="{{ form.room.id_for_label }}">{{ form.room.label }}</label>
          {{ form.room }}
          {% if form.room.errors %}
            <div class="error">{{ form.room.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label>Day of Week (Select one or more) *</label>
          <div class="days-container">
            <div class="day-item">
              <input type="checkbox" id="day_monday" name="day_of_week" value="monday" class="day-checkbox">
              <label for="day_monday" class="day-label">M</label>
            </div>
            <div class="day-item">
              <input type="checkbox" id="day_tuesday" name="day_of_week" value="tuesday" class="day-checkbox">
              <label for="day_tuesday" class="day-label">T</label>
            </div>
            <div class="day-item">
              <input type="checkbox" id="day_wednesday" name="day_of_week" value="wednesday" class="day-checkbox">
              <label for="day_wednesday" class="day-label">W</label>
            </div>
            <div class="day-item">
              <input type="checkbox" id="day_thursday" name="day_of_week" value="thursday" class="day-checkbox">
              <label for="day_thursday" class="day-label">THU</label>
            </div>
            <div class="day-item">
              <input type="checkbox" id="day_friday" name="day_of_week" value="friday" class="day-checkbox">
              <label for="day_friday" class="day-label">F</label>
            </div>
            <div class="day-item">
              <input type="checkbox" id="day_saturday" name="day_of_week" value="saturday" class="day-checkbox">
              <label for="day_saturday" class="day-label">S</label>
            </div>
            <div class="day-item">
              <input type="checkbox" id="day_sunday" name="day_of_week" value="sunday" class="day-checkbox">
              <label for="day_sunday" class="day-label">SUN</label>
            </div>
          </div>
          <div class="selected-days-preview" id="selectedDaysPreview">
            <strong>Selected days:</strong> <span id="selectedDaysList"></span>
          </div>
          <div class="help-text">Click to select multiple days for this schedule</div>
          <div id="daysError" class="error" style="display: none;">Please select at least one day</div>
        </div>
        
        <div class="section-header">‚è∞ Time Slot</div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.start_time.id_for_label }}">{{ form.start_time.label }}</label>
            {{ form.start_time }}
            {% if form.start_time.errors %}
              <div class="error">{{ form.start_time.errors.0 }}</div>
            {% endif %}
            <div class="help-text">Format: HH:MM (24-hour)</div>
          </div>
          
          <div class="form-group">
            <label for="{{ form.end_time.id_for_label }}">{{ form.end_time.label }}</label>
            {{ form.end_time }}
            {% if form.end_time.errors %}
              <div class="error">{{ form.end_time.errors.0 }}</div>
            {% endif %}
            <div class="help-text">Format: HH:MM (24-hour)</div>
          </div>
        </div>
        
        <div class="section-header">üìö Class Details (Optional)</div>

        <!-- Faculty Selection Dropdown (SEARCHABLE) -->
        <div class="form-group">
          <label for="{{ form.faculty.id_for_label }}">{{ form.faculty.label }}</label>
          {{ form.faculty }}
          {% if form.faculty.errors %}
            <div class="error">{{ form.faculty.errors.0 }}</div>
          {% endif %}
          <div class="help-text">Search and select registered faculty</div>
        </div>

        <!-- Subject field -->
        <div class="form-group">
          <label for="{{ form.subject.id_for_label }}">{{ form.subject.label }}</label>
          {{ form.subject }}
          {% if form.subject.errors %}
            <div class="error">{{ form.subject.errors.0 }}</div>
          {% endif %}
          <div class="help-text">Subject or course name</div>
        </div>

        
        <div class="form-group">
          <div class="checkbox-group">
            {{ form.is_active }}
            <label for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
          </div>
          {% if form.is_active.errors %}
            <div class="error">{{ form.is_active.errors.0 }}</div>
          {% endif %}
          <div class="help-text">Uncheck to disable this schedule temporarily</div>
        </div>
        
        {% if form.non_field_errors %}
          <div class="error">{{ form.non_field_errors }}</div>
        {% endif %}
        
        <div class="form-actions">
          <a href="{% url 'schedule_list' %}" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">{{ button_text }}</button>
        </div>
      </form>
    </div>
  </div>

  <!-- jQuery (required for Select2) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Select2 JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  
  <script>
    // Initialize Select2 for Faculty dropdown
    $(document).ready(function() {
      $('select[name="faculty"]').select2({
        placeholder: 'Search and select faculty...',
        allowClear: true,
        width: '100%',
        templateResult: formatFaculty,
        templateSelection: formatFacultySelection
      });
      
      // ========== FIX: PRE-SELECT DAYS WHEN EDITING ==========
      // Get the initial day values from Django form
      {% if form.initial.day_of_week %}
        var initialDays = {{ form.initial.day_of_week|safe }};
        if (Array.isArray(initialDays)) {
          initialDays.forEach(function(day) {
            var checkbox = document.getElementById('day_' + day);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
          updatePreview();
        }
      {% endif %}
      // =======================================================
    });

    // Format faculty display in dropdown
    function formatFaculty(faculty) {
      if (!faculty.id) {
        return faculty.text;
      }
      return faculty.text;
    }

    // Format selected faculty
    function formatFacultySelection(faculty) {
      return faculty.text || 'Select faculty...';
    }

    // Multiple days selection
    const checkboxes = document.querySelectorAll('.day-checkbox');
    const preview = document.getElementById('selectedDaysPreview');
    const daysList = document.getElementById('selectedDaysList');
    const daysError = document.getElementById('daysError');
    const form = document.getElementById('scheduleForm');
    
    // Add change event listener to all checkboxes
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updatePreview);
    });
    
    // Update the preview of selected days
    function updatePreview() {
      const selected = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.nextElementSibling.textContent);
      
      if (selected.length > 0) {
        preview.classList.add('active');
        daysList.textContent = selected.join(', ');
        daysError.style.display = 'none';
      } else {
        preview.classList.remove('active');
      }
    }
    
    // Form validation
    form.addEventListener('submit', function(e) {
      let isValid = true;
      
      // Check if semester is selected
      const semesterSelected = document.querySelector('input[name="semester"]:checked');
      const semesterError = document.getElementById('semesterError');
      
      if (!semesterSelected) {
        semesterError.style.display = 'block';
        isValid = false;
      } else {
        semesterError.style.display = 'none';
      }
      
      // Check if at least one day is selected
      const selectedDays = Array.from(checkboxes).filter(cb => cb.checked);
      
      if (selectedDays.length === 0) {
        daysError.style.display = 'block';
        daysError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        isValid = false;
      }
      
      if (!isValid) {
        e.preventDefault();
        return false;
      }
      
      return true;
    });
    
    // Initialize preview on page load (for edit mode)
    window.addEventListener('DOMContentLoaded', function() {
      updatePreview();
    });
  </script>
</body>
</html>